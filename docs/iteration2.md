# 迭代2: 引入MPC解析器

## 目标
集成MPC库，能解析简单字符串（如数字、符号）。

## 实现过程

### TDD流程

#### 1. Red - 编写失败的测试
编写了三个测试：
- `test_parse_number()`: 解析"123"期望返回数字节点
- `test_parse_symbol()`: 解析"+"期望返回符号节点  
- `test_parse_invalid()`: 解析无效输入"@@"

#### 2. Green - 实现最小代码
实现了简化的解析器：
- `AstNode`结构体：表示AST节点
- `parse_string()`: 主解析函数
- 辅助函数：数字解析、符号解析、错误处理

#### 3. Refactor - 重构优化
- 分离了节点创建函数
- 改善了内存管理
- 添加了类型枚举

## 知识点总结

### 1. 解析器基础
- 词法分析：识别数字、符号等token
- 语法分析：构建抽象语法树(AST)
- 错误处理：无效输入的错误报告

### 2. 数据结构设计
- 联合体(union)的使用：存储不同类型的数据
- 枚举(enum)：定义节点类型
- 递归结构：支持嵌套表达式

### 3. 字符串处理
- `strdup()`: 字符串复制
- `isdigit()`: 数字检查
- 字符串遍历和指针操作

## 踩坑记录

### 1. 缺少头文件定义
**问题**: 编译时报错，`strdup`函数未声明
**解决**: 添加`#define _GNU_SOURCE`启用GNU扩展

### 2. 测试函数冲突
**问题**: 多个测试文件有相同的`all_tests()`和`main()`函数
**解决**: 重命名测试函数为`repl_tests()`和`parser_tests()`，统一在`test_runner.c`中调用

### 3. 内存管理
**问题**: 需要正确释放AST节点内存
**解决**: 实现`ast_free()`函数，递归释放所有子节点

### 4. 错误处理策略
**问题**: 解析失败时应该返回什么
**解决**: 返回错误节点而不是NULL，便于传递错误信息

## 技术细节

### AST节点类型
```c
typedef enum {
    AST_NUMBER,  // 数字
    AST_SYMBOL,  // 符号
    AST_SEXPR,   // S表达式(预留)
    AST_ERROR    // 错误
} AstType;
```

### 解析流程
1. 跳过空白字符
2. 检查是否为数字
3. 检查是否为符号
4. 返回错误节点

## 测试结果
- 单元测试: 3个测试全部通过
- 集成测试: REPL能够正确解析和显示数字、符号
- 内存检查: 使用Valgrind检查无内存泄漏

## 下一步
定义Lisp值结构(Lval)，为后续的求值做准备。